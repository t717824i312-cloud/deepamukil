<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>College Fee Payment</title>
  <style>
    body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5;}
    .container{max-width:800px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
    h1{text-align:center;}
    label{display:block;margin-top:10px;}
    input,select,button,textarea{width:100%;padding:8px;margin-top:5px;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    table,th,td{border:1px solid #ccc;}
    th,td{padding:8px;text-align:left;}
    .tab{display:inline-block;padding:10px 20px;background:#eee;cursor:pointer;margin-right:5px;border-radius:5px 5px 0 0;}
    .tab.active{background:#ccc;}
    .tab-content{display:none;border:1px solid #ccc;padding:15px;border-radius:0 5px 5px 5px;background:#fafafa;}
    .tab-content.active{display:block;}
    .btn{margin-top:10px;background:#007BFF;color:#fff;border:none;cursor:pointer;}
    .btn:hover{background:#0056b3;}
    .summary{margin-top:20px;padding:10px;background:#f0f0f0;}
  </style>
</head>
<body>
  <div class="container">
    <h1>College Fee Payment</h1>

    <h2>Student Details</h2>
    <label>Name:<input type="text" id="studentName"></label>
    <label>Roll Number:<input type="text" id="roll"></label>
    <label>Department:<input type="text" id="dept"></label>
    <label>Semester:<input type="text" id="sem"></label>
    <label>Mobile:<input type="text" id="mobile"></label>
    <label>Email:<input type="email" id="email"></label>
    <label>Notes:<textarea id="notes"></textarea></label>

    <h2>Fee Items</h2>
    <label>Fee Type:
      <select id="feeType">
        <option value="Tuition">Tuition</option>
        <option value="Hostel">Hostel</option>
        <option value="Library">Library</option>
      </select>
    </label>
    <label>Amount:<input type="number" id="feeAmount"></label>
    <button class="btn" onclick="addItem()">Add Item</button>

    <table id="feeTable">
      <thead><tr><th>Type</th><th>Amount</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="summary">
      <label>Discount:<input type="number" id="discount" value="0"></label>
      <label>Late Fee:<input type="number" id="lateFee" value="0"></label>
      <h3>Grand Total: <span id="grandTotal">₹0</span></h3>
    </div>

    <h2>Payment Method</h2>
    <div>
      <div class="tab active" data-tab="upi">UPI</div>
      <div class="tab" data-tab="bank">Bank Transfer (NEFT/IMPS)</div>
      <div class="tab" data-tab="card">Cards / NetBanking</div>
    </div>

    <div id="upi" class="tab-content active">
      <p>College UPI ID: <b>krishdpi2006@oksbi</b> <button onclick="copyUPI()">Copy</button></p>
      <p>Account Name (Receiver): <b>Krishnakumar S</b></p>
      <button class="btn" id="payUPI">Pay via UPI App</button>
    </div>

    <div id="bank" class="tab-content">
      <p>Bank: State Bank of India</p>
      <p>Account Number: 1234567890</p>
      <p>IFSC: SBIN0000123</p>
    </div>

    <div id="card" class="tab-content">
      <button class="btn" id="mockGateway">Proceed to Mock Payment Gateway</button>
    </div>

    <button class="btn" id="generateReceipt">Generate Receipt</button>
  </div>

<script>
const byId = id => document.getElementById(id);
let state={items:[]};

function addItem(){
  const type=byId('feeType').value;
  const amt=Number(byId('feeAmount').value);
  if(!amt){alert('Enter amount');return}
  state.items.push({type,amt});
  renderTable();
}

function removeItem(i){state.items.splice(i,1);renderTable();}

function renderTable(){
  const tbody=byId('feeTable').querySelector('tbody');
  tbody.innerHTML='';
  state.items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=<td>${it.type}</td><td>₹${it.amt}</td><td><button onclick="removeItem(${i})">Remove</button></td>;
    tbody.appendChild(tr);
  });
  updateTotal();
}

function updateTotal(){
  let sum=state.items.reduce((a,b)=>a+b.amt,0);
  const discount=Number(byId('discount').value)||0;
  const late=Number(byId('lateFee').value)||0;
  sum=sum-discount+late;
  if(sum<0)sum=0;
  byId('grandTotal').textContent='₹'+sum;
}

document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    byId(tab.dataset.tab).classList.add('active');
  });
});

function copyUPI(){navigator.clipboard.writeText('krishdpi2006@oksbi').then(()=>alert('UPI ID copied'));}

function validateStudent(){
  if(!byId('studentName').value||!byId('roll').value||!byId('dept').value||!byId('sem').value){alert('Fill student details');return false;}
  return true;
}

async function postFeeData(method, total) {
  const payload = {
    studentName: byId('studentName').value,
    roll: byId('roll').value,
    dept: byId('dept').value,
    sem: byId('sem').value,
    mobile: byId('mobile').value,
    email: byId('email').value,
    notes: byId('notes').value,
    items: state.items,
    discount: byId('discount').value,
    lateFee: byId('lateFee').value,
    grandTotal: total,
    method: method,
    timestamp: new Date().toISOString()
  };

  try {
    const res = await fetch(""https://deepamukil1.onrender.com"", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log("✅ Server response:", data);
  } catch (err) {
    console.error("❌ Error sending data:", err);
  }
}

byId('generateReceipt').addEventListener('click',()=>{
  if(!validateStudent()){return}
  const total=Number(grandTotal.textContent.replace(/[^0-9.]/g,''));
  if(!(total>0)){alert('Add fee items before generating receipt.');return}
  const method=document.querySelector('.tab.active').dataset.tab.toUpperCase();

  postFeeData(method,total);

  const win=window.open('','_blank');
  win.document.write(`<h1>Payment Receipt</h1>
    <p>Name: ${byId('studentName').value}</p>
    <p>Roll: ${byId('roll').value}</p>
    <p>Department: ${byId('dept').value}</p>
    <p>Semester: ${byId('sem').value}</p>
    <p>Mobile: ${byId('mobile').value}</p>
    <p>Email: ${byId('email').value}</p>
    <p>Notes: ${byId('notes').value}</p>
    <h2>Items</h2>
    <ul>${state.items.map(i=><li>${i.type}: ₹${i.amt}</li>).join('')}</ul>
    <p>Discount: ₹${byId('discount').value}</p>
    <p>Late Fee: ₹${byId('lateFee').value}</p>
    <h3>Grand Total: ₹${total}</h3>
    <p>Method: ${method}</p>
    <p>Date: ${new Date().toLocaleString()}</p>`);
});

byId('payUPI').addEventListener('click',()=>{
  if(!validateStudent()){return}
  const total=Number(grandTotal.textContent.replace(/[^0-9.]/g,''));
  if(!(total>0)){alert('Add items first');return}

  postFeeData("UPI", total);

  // ✅ Generate UPI deep link
  const upiID = "krishdpi2006@oksbi";   // college UPI ID
  const name = "Krishnakumar S";        // receiver name
  const note = "College Fee Payment";   // note
  const link = upi://pay?pa=${upiID}&pn=${encodeURIComponent(name)}&am=${total}&cu=INR&tn=${encodeURIComponent(note)};

  // Redirect to UPI app
  window.location.href = link;
});

byId('mockGateway').addEventListener('click',()=>{
  if(!validateStudent()){return}
  const total=Number(grandTotal.textContent.replace(/[^0-9.]/g,''));
  if(!(total>0)){alert('Add items first');return}
  postFeeData("CARD", total);
  alert('Redirecting to Mock Gateway...');
});
</script>
</body>
</html>